<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Interactive Resume Editor & Preview</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<script src="https://mozilla.github.io/pdf.js/build/pdf.mjs" type="module"></script>

		<!-- CodeMirror CSS -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css" />
		<style>
			.CodeMirror {
				height: 100%;
				font-size: 14px;
			}
		</style>
	</head>
	<body class="bg-gray-100 h-screen flex flex-col font-sans text-gray-800">
		<header class="bg-white shadow p-4 flex justify-between items-center">
			<h1 class="text-xl font-bold">Interactive Resume Editor</h1>
			<button id="download-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold px-5 py-2 rounded-lg">
				Download PDF
			</button>
		</header>

		<main class="flex flex-1 overflow-hidden h-[calc(100vh-72px)]">
			<!-- Editor Panel -->
			<div class="w-full md:w-1/2 flex flex-col bg-white shadow-inner border-r">
				<div class="p-3 bg-gray-100 border-b shrink-0">
					<h2 class="text-sm font-semibold text-gray-700">Configuration (`config.js`)</h2>
				</div>
				<div id="editor-container" class="flex-1 relative min-h-0 overflow-auto">
					<div id="error-message" class="hidden absolute bottom-0 left-0 right-0 bg-red-500 text-white p-2 text-sm z-10"></div>
				</div>
			</div>

			<!-- Preview Panel -->
			<div class="w-full md:w-1/2 flex flex-col bg-white shadow-inner">
				<div class="p-3 bg-gray-100 border-b shrink-0">
					<h2 class="text-sm font-semibold text-gray-700">Live Preview</h2>
				</div>
				<div id="preview-container" class="flex-1 overflow-auto p-4 bg-gray-200 flex flex-col items-center space-y-6"></div>
			</div>
		</main>

		<!-- Scripts -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>

		<script type="module">
			import { resumeConfig } from "./config.js";
			import { ResumeGenerator } from "./generator.js";

			const { pdfjsLib } = globalThis;
			pdfjsLib.GlobalWorkerOptions.workerSrc = `//mozilla.github.io/pdf.js/build/pdf.worker.mjs`;

			let editor;
			let resumeGeneratorInstance = null;
			const errorMessageDiv = document.getElementById("error-message");

			function debounce(func, delay) {
				let timeout;
				return function (...args) {
					clearTimeout(timeout);
					timeout = setTimeout(() => func.apply(this, args), delay);
				};
			}

			async function renderAllPages(arrayBuffer) {
				const previewContainer = document.getElementById("preview-container");
				previewContainer.innerHTML = "";

				const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
				const pdf = await loadingTask.promise;

				const pageForScaling = await pdf.getPage(1);
				const viewportForScaling = pageForScaling.getViewport({ scale: 1.0 });
				const scale = (previewContainer.clientWidth - 48) / viewportForScaling.width;

				for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
					const page = await pdf.getPage(pageNum);
					const scaledViewport = page.getViewport({ scale: scale });

					const canvas = document.createElement("canvas");
					canvas.className = "shadow-lg";
					const context = canvas.getContext("2d");
					canvas.height = scaledViewport.height;
					canvas.width = scaledViewport.width;

					previewContainer.appendChild(canvas);

					const renderContext = {
						canvasContext: context,
						viewport: scaledViewport,
					};
					await page.render(renderContext).promise;
				}
			}

			async function updatePreview() {
				errorMessageDiv.classList.add("hidden");
				try {
					const currentConfig = JSON.parse(editor.getValue());
					resumeGeneratorInstance = new ResumeGenerator(currentConfig);
					const pdfData = resumeGeneratorInstance.getArrayBuffer();
					await renderAllPages(pdfData);
				} catch (e) {
					errorMessageDiv.textContent = "Error: Invalid configuration. " + e.message;
					errorMessageDiv.classList.remove("hidden");
					console.error("Config Error:", e);
				}
			}

			function initializeEditor() {
				const editorContainer = document.getElementById("editor-container");
				editor = CodeMirror(editorContainer, {
					value: JSON.stringify(resumeConfig, null, 2),
					mode: { name: "javascript", json: true },
					theme: "material-darker",
					lineNumbers: true,
					autofocus: true,
				});
				editor.on("change", debounce(updatePreview, 750));
			}

			document.getElementById("download-btn").addEventListener("click", () => {
				if (resumeGeneratorInstance) {
					resumeGeneratorInstance.generate();
				} else {
					alert("Please wait for the preview to generate first.");
				}
			});

			window.onload = () => {
				initializeEditor();
				updatePreview();
			};
		</script>
	</body>
</html>
