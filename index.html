<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive Resume Editor & Full Preview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://mozilla.github.io/pdf.js/build/pdf.mjs" type="module"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
  
  <style>
    .CodeMirror { height: 100%; font-size: 14px; }
  </style>
</head>
<body class="bg-gray-200 h-screen flex flex-col">

  <header class="bg-white shadow-md p-3 flex justify-between items-center z-10">
    <h1 class="text-xl font-bold text-gray-800">Interactive Resume Editor</h1>
    <button id="download-btn" class="bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700 transition-all">Download PDF</button>
  </header>

  <main class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 p-4 overflow-hidden">
    
    <div class="flex flex-col bg-white shadow-lg rounded-lg overflow-hidden">
      <div class="p-3 bg-gray-100 border-b">
        <h2 class="font-semibold text-gray-700">Configuration (`config.js`)</h2>
      </div>
      <div id="editor-container" class="flex-grow relative">
        <div id="error-message" class="hidden absolute bottom-0 left-0 right-0 bg-red-500 text-white p-2 text-sm z-20"></div>
      </div>
    </div>

    <div class="flex flex-col bg-white shadow-lg rounded-lg overflow-hidden">
      <div class="p-3 bg-gray-100 border-b">
        <h2 class="font-semibold text-gray-700">Live Preview</h2>
      </div>
      <div id="preview-container" class="flex-grow p-6 bg-gray-400 flex flex-col items-center overflow-y-auto">
        </div>
    </div>
  </main>

  <script type="module">
    // Import from config and generator files
    import { resumeConfig } from './config.js';
    import { ResumeGenerator } from './generator.js';

    let editor;
    let resumeGeneratorInstance = null;
    const errorMessageDiv = document.getElementById('error-message');
    const { pdfjsLib } = globalThis;

    pdfjsLib.GlobalWorkerOptions.workerSrc = `//mozilla.github.io/pdf.js/build/pdf.worker.mjs`;

    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // This is the new rendering logic that handles multiple pages
    async function renderAllPages(arrayBuffer) {
        const previewContainer = document.getElementById('preview-container');
        previewContainer.innerHTML = ''; // Clear any previous canvases

        const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
        const pdf = await loadingTask.promise;

        // Determine the scale based on the container width
        const pageForScaling = await pdf.getPage(1);
        const viewportForScaling = pageForScaling.getViewport({ scale: 1.0 });
        const scale = (previewContainer.clientWidth - 48) / viewportForScaling.width; // 48px for padding

        // Loop through all pages
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const scaledViewport = page.getViewport({ scale: scale });

            // Create a canvas for the current page
            const canvas = document.createElement('canvas');
            canvas.className = 'shadow-xl mb-6'; // Add margin between pages
            const context = canvas.getContext('2d');
            canvas.height = scaledViewport.height;
            canvas.width = scaledViewport.width;

            // Append the new canvas to our container
            previewContainer.appendChild(canvas);

            // Render the PDF page into the canvas context
            const renderContext = {
                canvasContext: context,
                viewport: scaledViewport,
            };
            await page.render(renderContext).promise;
        }
    }

    async function updatePreview() {
      errorMessageDiv.classList.add('hidden');
      try {
        const currentConfig = JSON.parse(editor.getValue());
        resumeGeneratorInstance = new ResumeGenerator(currentConfig);
        const pdfData = resumeGeneratorInstance.getArrayBuffer();
        await renderAllPages(pdfData);
      } catch (e) {
        errorMessageDiv.textContent = 'Error: Invalid configuration. ' + e.message;
        errorMessageDiv.classList.remove('hidden');
        console.error("Config Error:", e);
      }
    }

    function initializeEditor() {
      const editorContainer = document.getElementById('editor-container');
      editor = CodeMirror(editorContainer, {
        value: JSON.stringify(resumeConfig, null, 2),
        mode: { name: "javascript", json: true },
        theme: 'material-darker',
        lineNumbers: true,
        autofocus: true,
      });
      editor.on('change', debounce(updatePreview, 750));
    }
    
    document.getElementById('download-btn').addEventListener('click', () => {
      if (resumeGeneratorInstance) {
        resumeGeneratorInstance.generate();
      } else { alert("Please wait for the preview to generate first."); }
    });

    window.onload = () => {
      initializeEditor();
      updatePreview();
    };
  </script>
</body>
</html>